

IF OBJECT_ID('TEMPDB..#PROP_ORIGINAL') IS NOT NULL DROP TABLE #PROP_ORIGINAL
SELECT DISTINCT
 CGCPF_DEV										[CPF]
,TITUL_TRA										[TITUL_TRA]
,IDEMP_CON										[EMPRESA]
,CONVERT (DATE,DTAND_AND)						[DATA]
,CONVERT (VARCHAR(2),DTAND_AND,108)				[HORA] 
,CASE 
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) <= 90 THEN '1'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) > 90 THEN '2'
END [EQUIPE]
,CASE 
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 5 AND 30    THEN '1'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 31 AND 60   THEN '2'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 61 AND 90   THEN '3'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 91 AND 120  THEN '4'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 121 AND 180 THEN '5'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 181 AND 240 THEN '6'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 241 AND 300 THEN '7'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 301 AND 360 THEN '8'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 361 AND 480 THEN '9'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 481 AND 600 THEN '10'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 601 AND 720 THEN '11'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 721 AND 99999 THEN '12' ELSE '0'
END [GRUPO_ATRASO]
,CASE WHEN  IDDOC_DOC IN ('499','501','503','505','507','514','515','516','517','1011','1015','881','883','885','887','889','896','897','898','899','940','1013') THEN '1' /* 'Cartão'*/
      WHEN  IDDOC_DOC IN ('36','442','541','654','824','923') THEN '2' /*'Cheque e Adiantamento'*/
      WHEN  IDDOC_DOC IN ('521','1009','903','948') THEN '3' /*'Cheque PJ'*/
      WHEN  IDDOC_DOC IN ('527','528','531','909','910','913') THEN '4'  /*'CP'*/
      WHEN  IDDOC_DOC IN ('572','937','1055') THEN '5' /*CP não correntista PicPay'*/
      WHEN  IDDOC_DOC IN ('509','576','891','939') THEN '6' /*PicPay'*/
      WHEN  IDDOC_DOC IN ('534','916') THEN '7' /*'Fique No Verde'*/
      WHEN  IDDOC_DOC IN ('573','938') THEN '8' /*'Fique No Verde PJ'*/
      WHEN  IDDOC_DOC IN ('399','484','1016','781','866','1014') THEN '9'  /*'Renegociação'*/
	  WHEN  IDDOC_DOC IN ('953','1012','1020','954','1018','1021','953','1012','1020','954','1018','1021','1059') THEN '10'  /*'KG PRE PU'*/ 
	  WHEN  DESCR_DOC LIKE '%KG%' THEN '10'
	  ELSE '11' END [PRODUTO]
,CASE 
	WHEN (DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) <= 90) AND (VLFAT_TRA > 10000) THEN '1'
	WHEN (DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) > 90) AND (VLFAT_TRA > 25000) THEN '2'
ELSE 0
END [MAIOR_VALOR]
,MAX(VLCOR_PRO) [SALDO]
,MAX(VLCOR_PRO) [CONTABIL]
,ACORDO = 1
,CASE WHEN USUAR_PES IN ('FACAACORDO') AND IDDOC_TRA NOT IN ('572','509','576','953','937','891','939','954') THEN '4'
	  WHEN USUAR_PES IN ('WILSONR') THEN '2'
	  WHEN USUAR_PES IN ('WHATSR') THEN '3'
	  WHEN IDPES_PES IN (SELECT IDPES FROM DATA_SCIENCE..OPERADORES WHERE SETOR = 'DIGITAL') THEN '1' ELSE '5' END [ORIGEM]
,CASE WHEN IDOCO_AND = '1540' THEN '2'
	/*WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (527,528,909,910)		AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 1 AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (534,573,916,938)		AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 10 AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (442,541,654,824,923)	AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 1  AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (499,501,503,505,507,514,515,516,517,881,883,885,887,889,896,897,898,899) AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 35 AND 59 THEN '2'*/
	  WHEN IDOCO_AND IN ('1857','1906','1828','1834') THEN '3'
ELSE '1' END AS [FNV]
INTO #PROP_ORIGINAL
FROM		[10.251.1.36].[Nectar].[dbo].TB_ANDAMENTO
JOIN		[10.251.1.36].[Nectar].[dbo].TB_CONTRATO		ON IDCON_AND = IDCON_CON
JOIN	    [10.251.1.36].[Nectar].[dbo].TB_TRANSACAO		ON IDCON_TRA = IDCON_CON
JOIN	    [10.251.1.36].[Nectar].[dbo].TB_DOCUMENTO		ON IDDOC_DOC = IDDOC_TRA
JOIN		[10.251.1.36].[Nectar].[dbo].TB_DEVEDOR			ON IDDEV_CON = IDDEV_DEV
JOIN		[10.251.1.36].[Nectar].[dbo].TB_OCORRENCIA		ON IDOCO_AND = IDOCO_OCO
JOIN		(SELECT DISTINCT A.*,CGCPF_DEV AS CGCPF_PRO
				FROM		[10.251.1.36].[Nectar].[dbo].TB_PROPOST A
                INNER JOIN	[10.251.1.36].[Nectar].[dbo].TB_CONTRATO ON IDCON_CON = IDCON_PRO
                INNER JOIN	[10.251.1.36].[Nectar].[dbo].TB_DEVEDOR  ON IDDEV_CON = IDDEV_DEV
                )B											ON CGCPF_PRO = CGCPF_DEV AND CONVERT(DATE,DTAND_AND) = CONVERT(DATE,DTCAD_PRO)
LEFT JOIN	[10.251.1.36].[Nectar].[dbo].TB_PESSOAL			ON IDPES_PES = IDPES_AND
 

WHERE 
	IDOCO_OCO IN ('1766','400','607','1521','1540','1611','1617','1591','1592','1593','1828','1857','1906','1834','1938','1939','1940','1941','1942') 
AND CONVERT(DATE,DTAND_AND) = CONVERT(DATE,GETDATE())
AND IDEMP_CON = 8
AND STDEV_CON = 0
AND ALCAD_PES <> 9 
GROUP BY 
 CGCPF_DEV 
,TITUL_TRA
,IDEMP_CON								
,CONVERT (DATE,DTAND_AND)				
,CONVERT (VARCHAR(2),DTAND_AND,108)		
,CASE 
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) <= 90 THEN '1'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) > 90 THEN '2'
END
,CASE 
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 5 AND 30    THEN '1'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 31 AND 60   THEN '2'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 61 AND 90   THEN '3'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 91 AND 120  THEN '4'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 121 AND 180 THEN '5'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 181 AND 240 THEN '6'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 241 AND 300 THEN '7'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 301 AND 360 THEN '8'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 361 AND 480 THEN '9'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 481 AND 600 THEN '10'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 601 AND 720 THEN '11'
	WHEN DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) BETWEEN 721 AND 99999 THEN '12' ELSE '0'
END
,CASE WHEN  IDDOC_DOC IN ('499','501','503','505','507','514','515','516','517','1011','1015','881','883','885','887','889','896','897','898','899','940','1013') THEN '1' /* 'Cartão'*/
      WHEN  IDDOC_DOC IN ('36','442','541','654','824','923') THEN '2' /*'Cheque e Adiantamento'*/
      WHEN  IDDOC_DOC IN ('521','1009','903','948') THEN '3' /*'Cheque PJ'*/
      WHEN  IDDOC_DOC IN ('527','528','531','909','910','913') THEN '4'  /*'CP'*/
      WHEN  IDDOC_DOC IN ('572','937','1055') THEN '5' /*CP não correntista PicPay'*/
      WHEN  IDDOC_DOC IN ('509','576','891','939') THEN '6' /*PicPay'*/
      WHEN  IDDOC_DOC IN ('534','916') THEN '7' /*'Fique No Verde'*/
      WHEN  IDDOC_DOC IN ('573','938') THEN '8' /*'Fique No Verde PJ'*/
      WHEN  IDDOC_DOC IN ('399','484','1016','781','866','1014') THEN '9'  /*'Renegociação'*/
	  WHEN  IDDOC_DOC IN ('953','1012','1020','954','1018','1021','953','1012','1020','954','1018','1021','1059') THEN '10'  /*'KG PRE PU'*/ 
	  WHEN  DESCR_DOC LIKE '%KG%' THEN '10'
	  ELSE '11' END
,CASE WHEN (DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) <= 90) AND (VLFAT_TRA > 10000) THEN '1'
	  WHEN (DATEDIFF(DAY,DTATR_CON,CONVERT(DATE,DTAND_AND)) > 90) AND (VLFAT_TRA > 25000) THEN '2' ELSE 0 END 
,USUAR_PES
,IDPES_PES
,CASE WHEN IDOCO_AND = '1540' THEN '2'
	/*WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (527,528,909,910)		AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 1 AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (534,573,916,938)		AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 10 AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (442,541,654,824,923)	AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 1  AND 59 THEN '2'
      WHEN SCOAS_CON IN ('S','N') AND IDDOC_TRA IN (499,501,503,505,507,514,515,516,517,881,883,885,887,889,896,897,898,899) AND DATEDIFF(DAY,CONVERT(DATE,DTFAT_TRA),CONVERT(DATE,GETDATE())) BETWEEN 35 AND 59 THEN '2'*/
	  WHEN IDOCO_AND IN ('1857','1906','1828','1834') THEN '3'
ELSE '1' END
,IDDOC_TRA